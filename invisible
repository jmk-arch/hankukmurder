local connections = {
    SemiInvisible = {},
}

local isInvisible = false
local isBypassing = false
local isTransitioning = false
local clone, oldRoot, hip, connection
local uiConnection -- UI ê°ì§€ ì—°ê²°

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
_G.toggleSemiInvisible()
-----------------------------------------------------------
-- 1. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (íˆ¬ëª…í™” ë° ìºë¦­í„° ë³µêµ¬)
-----------------------------------------------------------
local function semiInvisibleFunction()
    if isTransitioning then
        warn("ì „í™˜ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
        return false
    end
    
    isTransitioning = true
    local TINY_SIZE = Vector3.new(0.5, 0.5, 0.5) 

    local function removeFolders()  
        local playerFolder = Workspace:FindFirstChild(LocalPlayer.Name)  
        if not playerFolder then return end  
        local names = {"DoubleRig", "Constraints"}
        for _, name in ipairs(names) do
            local obj = playerFolder:FindFirstChild(name)
            if obj then obj:Destroy() end
        end
    end  

    local function doClone()  
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("Humanoid") or char.Humanoid.Health <= 0 then  
            return false
        end
        
        hip = char.Humanoid.HipHeight  
        oldRoot = char:FindFirstChild("HumanoidRootPart")  
        if not oldRoot then return false end  

        local tempParent = Instance.new("Model", game)  
        char.Parent = tempParent  

        clone = oldRoot:Clone()  
        clone.Size = TINY_SIZE 
        clone.Transparency = 1 
        clone.CanCollide = false
        clone.Parent = char  
        
        oldRoot.Parent = Workspace.CurrentCamera 
        oldRoot.CanCollide = false
        clone.CFrame = oldRoot.CFrame  

        char.PrimaryPart = clone  
        char.Parent = Workspace  

        for _, v in pairs(char:GetDescendants()) do  
            if v:IsA("Weld") or v:IsA("Motor6D") then  
                if v.Part0 == oldRoot then v.Part0 = clone end  
                if v.Part1 == oldRoot then v.Part1 = clone end  
            end  
        end  
        tempParent:Destroy()  
        
        task.wait(0.1)
        return true  
    end  

    local function revertClone()  
        if not oldRoot or not LocalPlayer.Character then 
            isTransitioning = false
            return false
        end
        
        local char = LocalPlayer.Character
        local tempParent = Instance.new("Model", game)  
        char.Parent = tempParent  

        oldRoot.Parent = char  
        char.PrimaryPart = oldRoot  
        char.Parent = Workspace  

        for _, v in pairs(char:GetDescendants()) do  
            if v:IsA("Weld") or v:IsA("Motor6D") then  
                if v.Part0 == clone then v.Part0 = oldRoot end  
                if v.Part1 == clone then v.Part1 = oldRoot end  
            end  
        end  

        if clone then  
            local oldPos = clone.CFrame  
            clone:Destroy()  
            clone = nil  
            oldRoot.CFrame = oldPos  
        end  
        
        oldRoot.CanCollide = true
        oldRoot = nil  
        if char:FindFirstChild("Humanoid") then 
            char.Humanoid.HipHeight = hip 
        end  
        tempParent:Destroy()
        
        task.wait(0.1)
        return true
    end  

    local success = false
    
    if not isInvisible then
        removeFolders()
        if doClone() then
            isInvisible = true
            connection = RunService.Heartbeat:Connect(function()  
                if oldRoot and clone and oldRoot.Parent then  
                    oldRoot.CFrame = clone.CFrame * CFrame.new(0, -500, 0)
                    oldRoot.Velocity = Vector3.new(0, 0, 0)
                    oldRoot.RotVelocity = Vector3.new(0, 0, 0)
                    oldRoot.CanCollide = false
                end  
            end)
            table.insert(connections.SemiInvisible, connection)
            success = true
        end
    else
        if connection then 
            connection:Disconnect()
            connection = nil
        end
        if revertClone() then
            isInvisible = false
            for _, conn in ipairs(connections.SemiInvisible) do 
                if conn then conn:Disconnect() end 
            end
            connections.SemiInvisible = {}
            success = true
        end
    end
    
    isTransitioning = false
    return success
end

-----------------------------------------------------------
-- 2. Namecall í›„í‚¹ ë° ì‹¤í–‰ ì œì–´
-----------------------------------------------------------
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()

    if not checkcaller() and typeof(self) == "Instance" and (method == "FireServer" or method == "fireServer") then
        if (self.Name == "RequestFire" or self.Name == "RequestThrow") and isInvisible and not isBypassing then
            
            isBypassing = true

            task.spawn(function()
                local targetCFrame = nil
                local targetVelocity = Vector3.new(0, 0, 0)
                
                if clone and clone.Parent then
                    targetCFrame = clone.CFrame
                end
                
                local success = semiInvisibleFunction()
                
                if not success then
                    isBypassing = false
                    return
                end
                
                local char = LocalPlayer.Character
                local currentRoot = char and char:FindFirstChild("HumanoidRootPart")
                
                if currentRoot and targetCFrame then
                    currentRoot.CFrame = targetCFrame
                    currentRoot.Velocity = targetVelocity
                    currentRoot.RotVelocity = Vector3.new(0, 0, 0)
                end
                
                task.wait(0.2)
                
                pcall(function()
                    self:FireServer(unpack(args))
                end)
                
                task.wait(0.15)
                
                if not isInvisible then
                    semiInvisibleFunction()
                end
                
                isBypassing = false
            end)

            return
        end
    end
    
    return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-----------------------------------------------------------
-- 3. UI ê¸°ë°˜ ìë™ í† ê¸€ ì‹œìŠ¤í…œ
-----------------------------------------------------------
local function setupUIMonitor()
    local function getCoinUI()
        local success, result = pcall(function()
            return LocalPlayer.PlayerGui.MainUI.Round.Coin
        end)
        return success and result or nil
    end
    
    local function checkAndToggle()
        local coinUI = getCoinUI()
        if not coinUI then return end
        
        -- Coinì´ ë³´ì´ë©´ í™œì„±í™”, ì•ˆ ë³´ì´ë©´ ë¹„í™œì„±í™”
        if coinUI.Visible and not isInvisible then
            print("ğŸŸ¢ Coin UI ê°ì§€ - Semi-Invisible í™œì„±í™”")
            semiInvisibleFunction()
        elseif not coinUI.Visible and isInvisible then
            print("ğŸ”´ Coin UI ìˆ¨ê¹€ - Semi-Invisible ë¹„í™œì„±í™”")
            semiInvisibleFunction()
        end
    end
    
    -- ì´ˆê¸° ìƒíƒœ ì²´í¬
    task.wait(1)
    local coinUI = getCoinUI()
    
    if coinUI then
        -- Visible ì†ì„± ë³€ê²½ ê°ì§€
        uiConnection = coinUI:GetPropertyChangedSignal("Visible"):Connect(checkAndToggle)
        
        -- ì´ˆê¸° ìƒíƒœ ì ìš©
        checkAndToggle()
        
        print("âœ… UI ìë™ í† ê¸€ ì‹œìŠ¤í…œ í™œì„±í™”ë¨")
    else
        warn("âš ï¸ Coin UIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    end
end

-----------------------------------------------------------
-- 4. ì•ˆì „ ì¥ì¹˜: ìºë¦­í„° ë¦¬ìŠ¤í° ë° ì‚¬ë§ ê°ì§€
-----------------------------------------------------------
local function onCharacterDeath()
    if isInvisible then
        print("âš ï¸ ì‚¬ë§ ê°ì§€ - Semi-Invisible ë¹„í™œì„±í™” ì¤‘...")
        
        if connection then connection:Disconnect() end
        for _, conn in ipairs(connections.SemiInvisible) do
            if conn then conn:Disconnect() end
        end
        connections.SemiInvisible = {}
        isInvisible = false
        isBypassing = false
        isTransitioning = false
        clone = nil
        oldRoot = nil
        
        print("âœ… Semi-Invisibleì´ ì•ˆì „í•˜ê²Œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
    end
end

LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    
    local humanoid = char:WaitForChild("Humanoid", 5)
    if humanoid then
        humanoid.Died:Connect(onCharacterDeath)
    end
    
    onCharacterDeath()
    
    -- UI ëª¨ë‹ˆí„° ì¬ì„¤ì •
    task.wait(1)
    setupUIMonitor()
end)

-- í˜„ì¬ ìºë¦­í„°ì—ë„ ì‚¬ë§ ê°ì§€ ì¶”ê°€
if LocalPlayer.Character then
    local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.Died:Connect(onCharacterDeath)
    end
end

-----------------------------------------------------------
-- 5. ê¸°ëŠ¥ ì¢…ë£Œ í•¨ìˆ˜ (ì „ì—­)
-----------------------------------------------------------
_G.disableSemiInvisible = function()
    if isInvisible then
        semiInvisibleFunction()
    end
    
    -- UI ì—°ê²° í•´ì œ
    if uiConnection then
        uiConnection:Disconnect()
        uiConnection = nil
    end
    
    for _, conn in ipairs(connections.SemiInvisible) do
        if conn then conn:Disconnect() end
    end
    connections.SemiInvisible = {}
    isBypassing = false
    isTransitioning = false
    clone = nil
    oldRoot = nil
    print("âœ… Semi-Invisible ê¸°ëŠ¥ì´ ì™„ì „íˆ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
end

_G.toggleSemiInvisible = function()
    return semiInvisibleFunction()
end

-----------------------------------------------------------
-- 6. ì´ˆê¸° ì‹¤í–‰
-----------------------------------------------------------
setupUIMonitor()
